<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PCA leverage for outlier detection in high-dimensional data with `clever` • clever</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="PCA leverage for outlier detection in high-dimensional data with `clever`">
<meta property="og:description" content="clever">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">clever</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette.html">PCA leverage for outlier detection in high-dimensional data with `clever`</a>
    </li>
    <li>
      <a href="../articles/vignette_new_RD.html">PCA leverage for outlier detection in high-dimensional data with `clever`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mandymejia/clever/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>PCA leverage for outlier detection in high-dimensional data with <code>clever</code>
</h1>
                        <h4 data-toc-skip class="author">Amanda Mejia, Preya Shah &amp; Damon Pham</h4>
            
            <h4 data-toc-skip class="date">2021-05-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mandymejia/clever/blob/master/vignettes/vignette.Rmd" class="external-link"><code>vignettes/vignette.Rmd</code></a></small>
      <div class="hidden name"><code>vignette.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span>
<span class="va">opts_chunk</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>autodep <span class="op">=</span> <span class="cn">TRUE</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor" aria-hidden="true"></a>Overview</h1>
<p><code>clever</code> implements the <em>PCA leverage</em> outlier detection method for high-dimensional (HD) data, as detailed in this manuscript:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"clever"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></code></pre></div>
<pre><code>## 
## Mejia AF, Nebel MB, Eloyan A, Caffo B, Lindquist MA (2017). "PCA
## leverage: outlier detection for high-dimensional functional magnetic
## resonance imaging data." _Biostatistics_, *18*(3), 521-536. doi:
## 10.1093/biostatistics/kxw050 (URL:
## https://doi.org/10.1093/biostatistics/kxw050).
## 
## A BibTeX entry for LaTeX users is
## 
##   @Article{mejiaPCALeverageOutlier2017a,
##     title = {PCA leverage: outlier detection for high-dimensional functional magnetic resonance imaging data},
##     author = {Amanda F Mejia and Mary Beth Nebel and Ani Eloyan and Brian Caffo and Martin A. Lindquist},
##     journal = {Biostatistics},
##     year = {2017},
##     volume = {18},
##     number = {3},
##     pages = {521--536},
##     publisher = {Oxford University Press},
##     doi = {10.1093/biostatistics/kxw050},
##   }</code></pre>
<p>In summary, the manuscript proposes a measure of “outlyingness” for HD data observations by drawing on the traditional statistical ideas of PCA, leverage, and outlier detection. While its primary application is detecting outlying timepoints in an fMRI scan, the method can also be applied to other forms of HD data such as gene expression data.</p>
<p>In addition to PCA leverage, we have also implemented two other measures of outlyingness: <em>robust distance</em>, described in the same manuscript as PCA leverage, and <em>DVARS</em>, as formulated by this manuscript:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"clever"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<pre><code>## 
## Afyouni S, Nichols TE (2018). "Insight and inference for DVARS."
## _Neuroimage_, *172*, 291-312. doi: 10.1016/j.neuroimage.2017.12.098
## (URL: https://doi.org/10.1016/j.neuroimage.2017.12.098), This citation
## is for the DVARS measure of outlyingness.
## 
## A BibTeX entry for LaTeX users is
## 
##   @Article{afyouniInsightInferenceDVARS2018a,
##     note = {This citation is for the DVARS measure of outlyingness.},
##     title = {Insight and inference for DVARS},
##     author = {Soroosh Afyouni and Thomas E Nichols},
##     journal = {Neuroimage},
##     year = {2018},
##     volume = {172},
##     pages = {291--312},
##     publisher = {Elsevier},
##     doi = {10.1016/j.neuroimage.2017.12.098},
##   }</code></pre>
<div id="method-outline" class="section level3">
<h3 class="hasAnchor">
<a href="#method-outline" class="anchor" aria-hidden="true"></a>Method outline</h3>
<p>As input, <code>clever</code> takes a <span class="math inline">\(T\)</span> x <span class="math inline">\(V\)</span> matrix, <span class="math inline">\(Y\)</span>. In our case, <span class="math inline">\(Y\)</span> represents an fMRI run: each row is a vectorized volume, and each column represents one timepoint. Next, the algorithm performs the following steps:</p>
<ol style="list-style-type: decimal">
<li><p>Normalize <span class="math inline">\(Y\)</span> by centering and scaling its columns robustly.</p></li>
<li><p>Perform PCA on the normalized <span class="math inline">\(Y\)</span> matrix using the singular value decomposition (SVD) in order to obtain the <span class="math inline">\(T \times T\)</span> PC score matrix, <span class="math inline">\(U\)</span>.</p></li>
<li><p>Some PCs are removed from <span class="math inline">\(U\)</span> to obtain the <span class="math inline">\(Q \times T\)</span> (<span class="math inline">\(Q &lt; T\)</span>) matrix, <span class="math inline">\(U'\)</span>. The PCs which are retained are those likley to contain outlier information: PCs with greater-than-average variance, or PCs with both high variance and high kurtosis. (The removal of at least one PC is also a theoretical requirement for leverage; additionally, the robust distance method requires <span class="math inline">\(Q\)</span> to be appropriately small relative to <span class="math inline">\(T\)</span>.)</p></li>
<li><p>Next, leverage and/or robust distance is measured. The output of each is a length <span class="math inline">\(T\)</span> vector representing the “outlyingness” of each time point.</p></li>
<li><p>The outlyingness measures are thresholded to obtain the set of identified outliers.</p></li>
</ol>
<p>We also include the DVARS outlier detection method in <code>clever</code>. It normalizes the data as explained in step 1 (and not as described in the paper cited above), but otherwise follows the algorithm as described in the paper and implemented in the <a href="https://github.com/asoroosh/DVARS" class="external-link">MATLAB code</a> provided by the authors.</p>
</div>
<div id="installation" class="section level3">
<h3 class="hasAnchor">
<a href="#installation" class="anchor" aria-hidden="true"></a>Installation</h3>
<p>Install the package from GitHub and load it:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'mandymejia/clever'</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mandymejia/clever" class="external-link">clever</a></span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="tutorial" class="section level1">
<h1 class="hasAnchor">
<a href="#tutorial" class="anchor" aria-hidden="true"></a>Tutorial</h1>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor" aria-hidden="true"></a>Data</h3>
<p><code>clever</code> includes data from the Autism and Brain Imaging Data Exchange (ABIDE), a publicly available resource of neuroimaging and phenotypic information <a href="https://doi.org/10.1038/mp.2013.78" class="external-link">(Di Martino and others, 2014)</a>. Our simulated datasets are based on resting-state fMRI scans from two ABIDE subjects: the first contains artifacts likely due to a couple periods of high subject head motion; the second is relatively artifact-free. Axial slices are used instead of the entire volumes to minimize the download time of <code>clever</code>.</p>
</div>
<div id="example-results" class="section level3">
<h3 class="hasAnchor">
<a href="#example-results" class="anchor" aria-hidden="true"></a>Example results</h3>
<p>Here we will run through a simple example. First let’s pull the data:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Dat1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Dat2</span><span class="op">)</span></code></pre></div>
<p>The data for both subjects consist of a single slice from an fMRI volume. A brain mask has been applied to vectorize the data, forming a <span class="math inline">\(T \times V\)</span> (time by voxel) matrix.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Dat1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  193 4675</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Dat2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  145 4679</code></pre>
<p>We next run <code>clever</code> on both datasets. First, we will begin by looking at the standard implementation of PCA leverage:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clever.Dat1.var.lev</span> <span class="op">=</span> <span class="fu"><a href="../reference/clever.html">clever</a></span><span class="op">(</span><span class="va">Dat1</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, DVARS<span class="op">=</span><span class="cn">FALSE</span>, lev_images<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## Centering and scaling the data matrix.</code></pre>
<pre><code>## Warning in clever(Dat1, verbose = TRUE, DVARS = FALSE, lev_images = FALSE): Warning: 283 constant voxels (out of 4675). These will be removed for estimation of the covariance.</code></pre>
<pre><code>## Computing the PC scores.
## Identifying the PCs with high kurtosis.
## Method PCA_kurt__leverage: Outliers detected.
## Done!</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clever.Dat2.var.lev</span> <span class="op">=</span> <span class="fu"><a href="../reference/clever.html">clever</a></span><span class="op">(</span><span class="va">Dat2</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, DVARS<span class="op">=</span><span class="cn">FALSE</span>, lev_images<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## Centering and scaling the data matrix.</code></pre>
<pre><code>## Warning in clever(Dat2, verbose = TRUE, DVARS = FALSE, lev_images = FALSE): Warning: 68 constant voxels (out of 4679). These will be removed for estimation of the covariance.</code></pre>
<pre><code>## Computing the PC scores.
## Identifying the PCs with high kurtosis.
## Method PCA_kurt__leverage: Outliers detected.
## Done!</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">clever.Dat1.var.lev</span>, plot_title<span class="op">=</span><span class="st">"Dat1"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-9-1.png" width="384"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">clever.Dat2.var.lev</span>, plot_title<span class="op">=</span><span class="st">"Dat2"</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-10-1.png" width="384"></p>
<p>PCA leverage indicates clear outliers in the first dataset around the 60th and 150th timepoints. While the second dataset is mostly artifact-free, PCA leverage does indicate a few potential outliers around the 40th and 110th timepoints.</p>
<p>Next, we can run all methods included in <code>clever</code> and compare the results:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clever.Dat1</span> <span class="op">=</span> <span class="fu"><a href="../reference/clever.html">clever</a></span><span class="op">(</span><span class="va">Dat1</span>, projection<span class="op">=</span><span class="st">"all"</span>, out_meas<span class="op">=</span><span class="st">"all"</span>, 
                     lev_images<span class="op">=</span><span class="cn">TRUE</span>, verbose<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## Centering and scaling the data matrix.</code></pre>
<pre><code>## Warning in clever(Dat1, projection = "all", out_meas = "all", lev_images = TRUE, : Warning: 283 constant voxels (out of 4675). These will be removed for estimation of the covariance.</code></pre>
<pre><code>## Computing DVARS.
## Computing the normal and trend-filtered PC scores and directions.
## Identifying the PCs with high varaince.
## Identifying the PCs with high kurtosis.
## Identifying the trend-filtered PCs with high varaince.
## Method PCA_var__leverage: Outliers detected. Computing leverage images.
## Method PCA_kurt__leverage: Outliers detected. Computing leverage images.
## Method PCA_var__robdist: Outliers detected. Computing leverage images.
## Method PCA_kurt__robdist: Outliers detected. Computing leverage images.
## Method PCATF__leverage: Outliers detected. Computing leverage images.
## Done!</code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clever.Dat2</span> <span class="op">=</span> <span class="fu"><a href="../reference/clever.html">clever</a></span><span class="op">(</span><span class="va">Dat2</span>, projection<span class="op">=</span><span class="st">"all"</span>, out_meas<span class="op">=</span><span class="st">"all"</span>, 
                     lev_images<span class="op">=</span><span class="cn">TRUE</span>, verbose<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## Centering and scaling the data matrix.</code></pre>
<pre><code>## Warning in clever(Dat2, projection = "all", out_meas = "all", lev_images = TRUE, : Warning: 68 constant voxels (out of 4679). These will be removed for estimation of the covariance.</code></pre>
<pre><code>## Computing DVARS.
## Computing the normal and trend-filtered PC scores and directions.
## Identifying the PCs with high varaince.
## Identifying the PCs with high kurtosis.
## Identifying the trend-filtered PCs with high varaince.
## Method PCA_var__leverage: Outliers detected. Computing leverage images.
## Method PCA_kurt__leverage: Outliers detected. Computing leverage images.
## Method PCA_var__robdist: Outliers detected. Computing leverage images.
## Method PCA_kurt__robdist: Outliers detected. Computing leverage images.
## Method PCATF__leverage: No outliers detected. Skipping leverage images.
## Done!</code></pre>
<p>Here are the outliers for the first dataset:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">clever.Dat1</span>, <span class="st">"all"</span>, plot_title<span class="op">=</span><span class="st">"Dat1"</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p>And for the second:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">clever.Dat2</span>, <span class="st">"all"</span>, plot_title<span class="op">=</span><span class="st">"Dat2"</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
<p>For the first dataset, most methods identify outliers around timepoints 60 and 150 consistently. A few other timepoints are flagged as well for scrubbing and DVARS, and robust distance flags many more timepoints. For the second dataset, weaker outliers are identified around timepoint 40 and 110 inconsistently. Overall, these results are consistent with our prior knowledge of both datasets.</p>
</div>
<div id="fmri-image-reconstruction" class="section level3">
<h3 class="hasAnchor">
<a href="#fmri-image-reconstruction" class="anchor" aria-hidden="true"></a>fMRI image reconstruction</h3>
<p>To validate our results, we can reconstruct the original fMRI images using the mask which was applied to vectorize the data. See <code><a href="../reference/Matrix_to_VolumeTimeSeries.html">clever::Matrix_to_VolumeTimeSeries</a></code> for a helper function to do this.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://rig.oro.us.com" class="external-link">oro.nifti</a></span><span class="op">)</span></code></pre></div>
<pre><code>## oro.nifti 0.10.3</code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">neurobase</span><span class="op">)</span>

<span class="co">#'  Selects a timepoint from a volume time series, and returns it after adding</span>
<span class="co">#'  the NIfTI header from the mask onto it.</span>
<span class="co">#' @param VolumeTimeSeries A 4D matrix. Time is on the 4th dimension.</span>
<span class="co">#' @param time The timepoint to select.</span>
<span class="co">#' @param mask The corresponding mask.</span>
<span class="co">#'</span>
<span class="co">#' @return The 3D volume with the NIfTI header from the mask.</span>
<span class="va">Volume_to_NIfTI</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">VolumeTimeSeries</span>, <span class="va">time</span>, <span class="va">mask</span><span class="op">)</span><span class="op">{</span>
  <span class="va">vol</span> <span class="op">&lt;-</span> <span class="va">VolumeTimeSeries</span><span class="op">[</span>,,,<span class="va">time</span><span class="op">]</span>
  <span class="va">vol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/copyNIfTIHeader.html" class="external-link">copyNIfTIHeader</a></span><span class="op">(</span>img<span class="op">=</span><span class="va">mask</span>, arr<span class="op">=</span><span class="va">vol</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">vol</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fname</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Dat1_mask.nii.gz"</span>, package <span class="op">=</span> <span class="st">"clever"</span><span class="op">)</span>
<span class="va">Mask1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/oro.nifti/man/read_nifti.html" class="external-link">readNIfTI</a></span><span class="op">(</span><span class="va">fname</span><span class="op">)</span> <span class="co">#Pitt_0050048 (full of artifacts)</span>
<span class="va">Img1</span> <span class="op">=</span> <span class="fu"><a href="../reference/Matrix_to_VolumeTimeSeries.html">Matrix_to_VolumeTimeSeries</a></span><span class="op">(</span><span class="va">Dat1</span>, <span class="va">Mask1</span><span class="op">)</span>

<span class="va">fname</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Dat2_mask.nii.gz"</span>, package <span class="op">=</span> <span class="st">"clever"</span><span class="op">)</span>
<span class="va">Mask2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/oro.nifti/man/read_nifti.html" class="external-link">readNIfTI</a></span><span class="op">(</span><span class="va">fname</span><span class="op">)</span>
<span class="va">Img2</span> <span class="op">=</span> <span class="fu"><a href="../reference/Matrix_to_VolumeTimeSeries.html">Matrix_to_VolumeTimeSeries</a></span><span class="op">(</span><span class="va">Dat2</span>, <span class="va">Mask2</span><span class="op">)</span></code></pre></div>
<p>Below, we compare the timepoint of median leverage (first) to the timepoint of maximum leverage (second) in the first dataset. We choose to use the kurtosis PC-selection method and leverage outlyingness measurement.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">levs</span> <span class="op">=</span> <span class="va">clever.Dat1</span><span class="op">$</span><span class="va">outlier_measures</span><span class="op">$</span><span class="va">PCA_var__leverage</span>
<span class="va">t_med</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>
<span class="va">t_max</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">Img1</span><span class="op">[</span>,,,<span class="va">t_med</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Median leverage (T = '</span>, <span class="va">t_med</span>, <span class="st">')'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">Img1</span><span class="op">[</span>,,,<span class="va">t_max</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Maximum leverage (T = '</span>, <span class="va">t_max</span>, <span class="st">')'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>The median time point appears normal, whereas the most outlying time point clearly has banding artifacts likely due to subject motion.</p>
</div>
<div id="leverage-images" class="section level3">
<h3 class="hasAnchor">
<a href="#leverage-images" class="anchor" aria-hidden="true"></a>Leverage images</h3>
<p><code>clever</code> can also display the “leverage images” for each outlying observation. There are two types: the composite of the selected PC directions, weighed by the scores for that observation (without scaling by variance), and the single PC direction with the highest score at that observation. To solve for these images, be sure to use <code>lev_images=TRUE</code> (already the default option).</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Lev_Img1</span> <span class="op">=</span> <span class="va">clever.Dat1</span><span class="op">$</span><span class="va">outlier_lev_imgs</span><span class="op">$</span><span class="va">PCA_var__leverage</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'The timepoints meeting the first outlier level threshold:\n'</span><span class="op">)</span></code></pre></div>
<pre><code>## The timepoints meeting the first outlier level threshold:</code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">Lev_Img1</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 59, 60, 61, 134, 149, 150, 151, 152, 153</code></pre>
<p>Here are the leverage images at timepoint 150 for the first dataset:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Constant voxels are deleted during the `clever` algorithm, so the leverage images will have</span>
<span class="co"># missing values where the constant voxels were. The NA_fill option is used here to make</span>
<span class="co"># these voxels have the same color as the background (out-of-mask voxels).</span>
<span class="va">Lev_Img1.mean</span> <span class="op">=</span> <span class="fu"><a href="../reference/Matrix_to_VolumeTimeSeries.html">Matrix_to_VolumeTimeSeries</a></span><span class="op">(</span><span class="va">Lev_Img1</span><span class="op">$</span><span class="va">mean</span>, <span class="va">Mask1</span><span class="op">)</span>
<span class="va">Lev_Img1.top</span> <span class="op">=</span> <span class="fu"><a href="../reference/Matrix_to_VolumeTimeSeries.html">Matrix_to_VolumeTimeSeries</a></span><span class="op">(</span><span class="va">Lev_Img1</span><span class="op">$</span><span class="va">top</span>, <span class="va">Mask1</span><span class="op">)</span>

<span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">Lev_Img1</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="va">t_max</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">Lev_Img1.mean</span><span class="op">[</span>,,,<span class="va">idx</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Lev. img., mean dir. (T='</span>,<span class="va">t_max</span>,<span class="st">')'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">Lev_Img1.top</span><span class="op">[</span>,,,<span class="va">idx</span><span class="op">]</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Lev. img., top dir. (T='</span>,<span class="va">t_max</span>,<span class="st">')'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>The leverage images highlight the banding artifact present at this time point.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Amanda Mejia, John Muschelli.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
